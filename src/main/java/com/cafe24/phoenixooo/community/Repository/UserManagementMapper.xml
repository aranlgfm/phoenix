<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe24.phoenixooo.community.Repository.UserManagementMapper">
	<!-- 
		0.코드증가 (autoincrement를 코드로 구현했음. 유저코드와 샾코드로 나누어짐)
		1.기본회원가입(UserCustomer)
		2.디자이너회원가입(UserDesigner : 기존에 있는 미용실코드 업데이트)
		3.미용실회원가입(UserDirector : 추가입력)미용실 코드 추가 및 미용실 상세정보 입력)
		4.유저코드셀렉(미용실 추가입력(4번) 등록시 필요한 메서드)
		5. 아이디/비번찾기 셀렉 
		
	
	
	-->

	<!-- 0.유저코드증가 -->
	<select id="getUserCode" resultType="String">
		SELECT USER_CD 
		FROM COM_USER_TB
		order by USER_JOIN_DT desc
		LIMIT 0,1
	</select>
	
	<!-- 0.샾코드증가 -->
	<select id="getShopCode" resultType="String">
		SELECT SHOP_CD 
		FROM CRM_SHOP_TB
		order by SHOP_JOIN_DT desc
		LIMIT 0,1
	</select>


	<!-- 1. 기본 회원가입 -->
	<insert id="insertUser" parameterType="com.cafe24.phoenixooo.community.Model.UserCustomer">
		INSERT INTO 
		COM_USER_TB
		(
			USER_CD
			,USER_GROUP_NM
			,USER_NM
			,USER_NICK_NM
			,USER_ID
			,USER_PW
			,USER_SEX_FL
			,USER_ANNIVERSARY_DT
			,USER_BIRTH_DT
			,USER_ADDR
			,USER_POST_NO
			,USER_EMAIL_ADDR
			,USER_JOIN_DT
			,USER_PHONE_NO
			,USER_CELLPHONE_NO
			,USER_INTRODUCE_CTT
		) 
		VALUES
		(
			#{userCode}
			,#{userGroupName}
			,#{userName}
			,#{userNickName}
			,#{userId}
			,#{userPw}
			,#{userSexFlag}
			,#{userAnniversaryDate}
			,#{userBirthdayDate}
			,#{userAddress}
			,#{userPostNumber}
			,#{userEmailAddress}
			,NOW()
			,#{userPhoneNumber}
			,#{userCellphoneNumber}
			,#{userIntroduceContent}
		)
	</insert>
	
	<!-- 2. 디자이너 회원가입 미용실코드 추가 -->
	<update id="insertDesigner" parameterType="com.cafe24.phoenixooo.community.Model.UserDesigner">
		UPDATE COM_USER_TB
		SET USER_SHOP_CD = #{shopCode}
		WHERE USER_CD = #{userCode}
	</update>
	
	<!-- 3. 미용실 회원가입 -->
	<insert id="insertDirector" parameterType="com.cafe24.phoenixooo.community.Model.UserDirector">
		INSERT INTO 
		CRM_SHOP_TB
		(
			SHOP_CD
			,USER_CD
			,SHOP_NM
			,SHOP_POST_NO
			,SHOP_ADDR
			,BUSINESS_NO
			,SHOP_MEMO
			,SHOP_JOIN_DT
		) 
		VALUES
		(
			#{shopCode}
			,#{userCode}
			,#{shopName}
			,#{shopPostNumber}
			,#{shopAddress}
			,#{businessNumber}
			,#{shopMemo}
			,NOW()
		)
	</insert>
	
	<!-- 4. 유저코드 셀렉 -->
	<select id="getUserCodeForDirector" parameterType="com.cafe24.phoenixooo.community.Model.UserCustomer" resultType="String">
		SELECT USER_CD 
		FROM COM_USER_TB
		WHERE USER_ID = #{userId}
	</select>
	
	<!-- 5. 아이디찾기 셀렉  -->
	<select id="finding" parameterType="com.cafe24.phoenixooo.community.Model.UserCustomer" resultType="String">
		<choose>
			<!-- 아이디찾기 -->
			<when test="userName != null and userName !='' ">
				SELECT USER_ID
				FROM COM_USER_TB
				WHERE 
				USER_EMAIL_ADDR = #{userEmailAddress} AND 
				USER_NM = #{userName} 
			</when>
			
			<!-- 비밀번호찾기 -->
			<when test="userId  != null and userId !='' ">
				SELECT USER_EMAIL_ADDR
				FROM COM_USER_TB
				WHERE 
				USER_EMAIL_ADDR = #{userEmailAddress} AND 
				USER_ID = #{userId} 
			</when>
		</choose>
	</select>
</mapper>